#!/usr/bin/env ruby
# An example of how to use the bloodymines game egnine within a curses program.

require "optparse"
require File.dirname(__FILE__) + "/../lib/bloodymines"
require File.dirname(__FILE__) + "/../lib/bloodymines/tui"

class Bloodymines
  include TUI
end

# main app
options = {}
optparse = OptionParser.new do |opts|
  opts.on('-h','--help', 'display this screen') { puts opts; exit }
  opts.on('-d', '--difficulty DIFFICULTY', [:beginner, :intermediate, :expert],
          "Set the difficulty of the game") do |d|
            options[:difficulty] = d
          end
end

begin
  optparse.parse!
rescue OptionParser::MissingArgument, OptionParser::InvalidArgument
  puts "The following difficulty levels are available: beginner, intermediate, expert"
  puts optparse
  exit
end

game = Bloodymines.new(:difficulty => options[:difficulty])
game.cursor_x = 0
game.cursor_y = 0

Curses.program do |scr|
  while true
    game.draw_field
    case getch
    when Key::UP : game.move(:direction => :up)
    when Key::DOWN : game.move(:direction => :down)
    when Key::LEFT : game.move(:direction => :left)
    when Key::RIGHT : game.move(:direction => :right)
    when 32 : game.uncover(game.cursor_x, game.cursor_y)
    when 27, ?q, ?Q : break
    end
    if game.ended?
      game.draw_field
      setpos(0, 1)
      addstr("Game Over. Hit any key to quit.")
      getch
      break
    end
  end

 close_screen
 if game.result[:finished]
   puts "You completed the game on #{game.difficulty.to_s.upcase}!"
 else
   puts "You did not manage to finish the game."
 end
 puts "Your final score was: #{game.result[:score]}"
end
